from flask import Flask, request, jsonify
from msal import ConfidentialClientApplication
import requests
import os

app = Flask(__name__)

# Microsoft Graph credentials
CLIENT_ID = '3776da3b-8051-48c7-8f1d-88ace0840be3'
CLIENT_SECRET = 'yEa8Q~AwSDepj4vM~LkrqDItdW9bjS0BbLQ4-cYg'
TENANT_ID = '50648dfc-8de9-4592-bdb6-e743c0757b08'
EMAIL = 'colesommi@lcbcchurch.com'

AUTHORITY = f"https://login.microsoftonline.com/{TENANT_ID}"
SCOPE = ["https://graph.microsoft.com/.default"]

@app.route('/create_event', methods=['POST'])
def create_event():
    data = request.json
    subject = data.get('subject')
    start_time = data.get('start_time')
    end_time = data.get('end_time')
    location = data.get('location', '')

    app_auth = ConfidentialClientApplication(
        client_id=CLIENT_ID,
        client_credential=CLIENT_SECRET,
        authority=AUTHORITY
    )
    token_response = app_auth.acquire_token_for_client(scopes=SCOPE)
    access_token = token_response['access_token']

    headers = {
        'Authorization': f'Bearer {access_token}',
        'Content-Type': 'application/json'
    }

    event = {
        "subject": subject,
        "start": {"dateTime": start_time, "timeZone": "Eastern Standard Time"},
        "end": {"dateTime": end_time, "timeZone": "Eastern Standard Time"},
        "location": {"displayName": location}
    }

    url = f"https://graph.microsoft.com/v1.0/me/events"
    response = requests.post(url, headers=headers, json=event)

    return jsonify({
        "status": response.status_code,
        "response": response.json()
    })

@app.route('/', methods=['GET'])
def home():
    return "Calendar API is running", 200

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 10000)))